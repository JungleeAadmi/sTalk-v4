<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>sTalk - Secure Chat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1F2937">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="apple-touch-icon" href="logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        :root {
            --theme-primary: #8B5CF6;
            --theme-secondary: #3B82F6;
            --theme-dark-bg: #1E1E1E;
            --primary-grad: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
        }

        /* LAYOUT FIXES FOR MOBILE KEYBOARD & SCROLLING */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent body scroll */
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
        }
        
        #view-main {
            height: 100dvh; /* Dynamic Viewport Height */
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        #chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease-in-out;
        }

        /* On mobile, chat interface starts off-screen */
        @media (max-width: 768px) {
            #chat-interface {
                position: absolute;
                top: 0; left: 0; width: 100%;
                z-index: 50;
                background-color: var(--theme-dark-bg);
            }
        }

        #chat-header {
            flex: 0 0 64px;
            z-index: 20;
        }

        #messages-container {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
            overscroll-behavior: contain;
        }

        #chat-input-area {
            flex: 0 0 auto;
            z-index: 20;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Component Styles */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .msg-bubble-self { background: var(--primary-grad); color: white; border-radius: 20px 20px 4px 20px; }
        .msg-bubble-other { background-color: #374151; color: #f3f4f6; border-radius: 20px 20px 20px 4px; }
        
        /* Ticks */
        .tick { transition: all 0.2s ease; font-size: 10px; margin-left: 4px; }
        .tick-sent { color: #9CA3AF; } /* Gray check */
        .tick-delivered { color: #9CA3AF; } /* Gray double check */
        .tick-read { color: #60A5FA; } /* Blue double check */

        /* Toggles */
        .toggle-checkbox {
            appearance: none; width: 3rem; height: 1.5rem; background: #4B5563;
            border-radius: 9999px; position: relative; cursor: pointer; outline: none; transition: background 0.3s;
        }
        .toggle-checkbox::after {
            content: ''; position: absolute; top: 0.125rem; left: 0.125rem; width: 1.25rem; height: 1.25rem;
            background: white; border-radius: 50%; transition: transform 0.3s;
        }
        .toggle-checkbox:checked { background: var(--theme-primary); }
        .toggle-checkbox:checked::after { transform: translateX(1.5rem); }
        
        .theme-swatch { width: 2.5rem; height: 2.5rem; border-radius: 9999px; cursor: pointer; }
        .theme-swatch.selected { outline: 3px solid var(--theme-primary); outline-offset: 2px; }
        
        .unread-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .highlight-user { background-color: rgba(139, 92, 246, 0.1); border-left: 4px solid var(--theme-primary); }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Nunito', 'sans-serif'] }, colors: { primary: 'var(--theme-primary)', themeDarkBg: 'var(--theme-dark-bg)', dark: '#111827' } } } }
    </script>
</head>
<body class="bg-gray-900 dark text-white">

    <!-- API & LOGIC -->
    <script>
        let socket;
        if (typeof io !== 'undefined') socket = io();
        else { console.error("Socket.io missing"); socket = { on:()=>{}, emit:()=>{} }; }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        class APIClient {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.chats = {};
                
                socket.on('users_update', (users) => {
                    this.users = users;
                    renderUserList();
                });
                
                socket.on('message_received', (msg) => {
                    // If chat is active and message belongs to it
                    if (activeChatId && (msg.senderId === activeChatId || msg.senderId === this.currentUser.id)) {
                        if (!this.chats[getChatRoomId(this.currentUser.id, activeChatId)]?.find(m => m.id === msg.id)) {
                            this.addMessageToLocal(msg);
                            updateUI();
                            if(msg.senderId === activeChatId) this.markRead(activeChatId);
                        }
                    }
                    if(msg.senderId !== this.currentUser.id) playNotificationSound();
                });
                
                // Update ticks for read/delivered
                socket.on('messages_read', ({chatId}) => {
                    if(this.chats[chatId]) {
                        this.chats[chatId].forEach(m => m.status = 'read');
                        if(activeChatId && getChatRoomId(this.currentUser.id, activeChatId) === chatId) updateUI();
                    }
                });
                
                socket.on('message_status_update', ({id, status, chatId}) => {
                    if(this.chats[chatId]) {
                        const m = this.chats[chatId].find(x => x.id === id);
                        if(m) { m.status = status; updateUI(); }
                    }
                });
                
                socket.on('chats_cleared', () => { this.chats = {}; updateUI(); alert("Admin cleared all chats."); });
            }

            // --- USER PROFILE UPDATE (Fixes Profile Pic) ---
            async updateUser(data) {
                try {
                    const res = await fetch(`/api/users/${this.currentUser.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        if(data.avatar) this.currentUser.avatar = data.avatar;
                        localStorage.setItem('sTalk_user', JSON.stringify(this.currentUser));
                        updateMyProfileUI();
                        return true;
                    }
                } catch (e) { console.error("Update failed", e); return false; }
            }

            // --- PUSH REGISTRATION (Fixes iOS) ---
            async registerPush() {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    // iOS Standalone Check
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                    if (navigator.userAgent.match(/iPhone|iPad/i) && !isStandalone) {
                        alert("To enable notifications on iOS, tap 'Share' -> 'Add to Home Screen', then open the app from there.");
                        return;
                    }
                    return alert("Push notifications not supported on this browser.");
                }
                
                const permission = await Notification.requestPermission();
                if(permission !== 'granted') return alert("Notification permission denied.");

                try {
                    const reg = await navigator.serviceWorker.ready;
                    const keyRes = await fetch('/api/push/key');
                    const { publicKey } = await keyRes.json();
                    
                    const sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });
                    
                    await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: this.currentUser.id, subscription: sub })
                    });
                    alert("Notifications Enabled Successfully!");
                    document.getElementById('notif-toggle').checked = true;
                } catch (err) {
                    console.error("Push Error:", err);
                    alert("Failed to subscribe. " + err.message);
                }
            }

            async login(username, password) {
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
                const data = await res.json();
                if (data.success) {
                    this.currentUser = data.user;
                    localStorage.setItem('sTalk_user', JSON.stringify(data.user));
                    this.fetchUsers();
                    // Attempt auto-register push on login if permission already granted
                    if (Notification.permission === "granted") this.registerPush();
                    return data.user;
                } else throw data.message;
            }
            
            async checkAuth() {
                const stored = localStorage.getItem('sTalk_user');
                if(stored) {
                    this.currentUser = JSON.parse(stored);
                    this.fetchUsers();
                    return true;
                }
                return false;
            }

            async fetchUsers() {
                const res = await fetch('/api/users');
                this.users = await res.json();
                renderUserList();
            }
            
            async markRead(senderId) {
                const roomId = getChatRoomId(this.currentUser.id, senderId);
                
                // Optimistic local update
                if (this.currentUser.unread) {
                    this.currentUser.unread[senderId] = 0;
                    renderUserList(); // Refresh UI to clear badge
                }

                await fetch('/api/chats/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: this.currentUser.id, senderId, chatId: roomId })
                });
            }

            async sendMessage(otherUserId, content, type='text', fileData=null, replyTo=null) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                const msg = { id: 'm' + Date.now(), chatId: roomId, senderId: this.currentUser.id, text: content, type, fileData, replyTo, sentAt: new Date().toISOString(), status: 'sent' };
                this.addMessageToLocal(msg);
                updateUI();
                try {
                    await fetch('/api/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chatId: roomId, message: msg, recipientId: otherUserId }) });
                } catch (e) { console.error(e); }
            }
            
            async loadMessages(otherUserId) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                socket.emit('join_room', roomId);
                try {
                    const res = await fetch(`/api/chats/${otherUserId}?chatId=${roomId}`);
                    this.chats[roomId] = await res.json();
                    updateUI();
                } catch (e) { this.chats[roomId] = []; updateUI(); }
            }
            
            addMessageToLocal(msg) {
                const roomId = msg.chatId;
                if (!this.chats[roomId]) this.chats[roomId] = [];
                this.chats[roomId].push(msg);
            }

            async createUser(n,u,p) { return (await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, username:u, password:p})})).json(); }
            async changePassword(p) { const r = await fetch(`/api/users/${this.currentUser.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:p})}); this.currentUser.mustChangePassword=false; localStorage.setItem('sTalk_user', JSON.stringify(this.currentUser)); return r.json(); }
            async adminResetPassword(id,p) { return (await fetch('/api/admin/reset-password', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id, newPassword:p})})).json(); }
            async deleteUser(id) { await fetch(`/api/users/${id}`, {method:'DELETE'}); this.fetchUsers(); }
        }

        function getChatRoomId(id1, id2) { return [id1, id2].sort().join('_'); }
        const server = new APIClient();
        let activeChatId = null, replyContext = null;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = localStorage.getItem('sTalk_sound') !== 'false';

        function playNotificationSound() {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            if (!soundEnabled) return;
            const t = audioCtx.currentTime, o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(1200, t); o.frequency.exponentialRampToValueAtTime(800, t + 0.1);
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
            o.start(t); o.stop(t + 1.5);
        }

        window.addEventListener('load', async () => {
            if ('serviceWorker' in navigator && window.location.protocol !== 'blob:') {
                 try { navigator.serviceWorker.register('/sw.js'); } catch(e){}
            }
            
            // Restore Theme
            const savedTheme = localStorage.getItem('sTalk_theme');
            if(savedTheme) applyTheme(parseInt(savedTheme));
            else applyTheme(2); 

            // Restore Wallpaper
            const savedBg = localStorage.getItem('sTalk_bg');
            if(savedBg) applyWallpaper();

            if (await server.checkAuth()) enterMainApp(server.currentUser);
        });
    </script>

    <!-- VIEWS -->
    
    <!-- 1. LOGIN -->
    <div id="view-login" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-gray-700">
            <img src="logo.svg" class="w-24 h-24 mx-auto mb-6 rounded-[20px] shadow-lg" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='block'">
            <div id="fallback-logo" class="hidden w-24 h-24 mx-auto mb-6 rounded-[20px] bg-purple-600"></div>
            <h1 class="text-2xl font-extrabold text-white mb-2">sTalk Login</h1>
            <input type="text" id="login-user" placeholder="Username" class="w-full p-4 rounded-xl bg-gray-700 text-white mb-3 outline-none font-semibold">
            <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-700 text-white mb-4 outline-none font-semibold">
            <button onclick="appLogin()" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-purple-600 to-blue-500 text-white font-bold shadow-lg active:scale-95 transition-transform">Login</button>
        </div>
    </div>

    <!-- 2. MAIN -->
    <div id="view-main" class="hidden flex-1 flex overflow-hidden relative bg-gray-900 text-white">
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-80 lg:w-96 bg-gray-800 border-r border-gray-700 flex flex-col z-10">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openSettingsModal()">
                    <!-- ROUNDED PROFILE PIC FIX: 'rounded-full' class here -->
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-purple-900 flex items-center justify-center text-purple-300 font-bold overflow-hidden border border-gray-700"></div>
                    <h2 id="my-username" class="font-bold text-white text-lg">User</h2>
                </div>
                <div class="flex gap-3">
                    <button id="admin-btn" onclick="toggleAdminPanel()" class="hidden w-8 h-8 rounded-full bg-red-900 text-red-200 flex items-center justify-center"><i class="fas fa-shield-alt"></i></button>
                    <button onclick="openSettingsModal()" class="w-8 h-8 rounded-full bg-gray-700 text-gray-300 flex items-center justify-center transition-colors hover:bg-gray-600"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="p-3">
                <input type="text" placeholder="Search" class="w-full p-2 bg-gray-700 rounded-lg text-white outline-none font-medium">
            </div>
            <div id="user-list" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- CHAT -->
        <div id="chat-interface" class="transform translate-x-full md:translate-x-0 bg-gray-900 flex flex-col z-20">
            <!-- FIXED HEADER -->
            <div id="chat-header" class="bg-gray-800 p-3 border-b border-gray-700 flex items-center justify-between shadow-sm z-30 h-16">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="md:hidden text-gray-300 p-2"><i class="fas fa-arrow-left text-xl"></i></button>
                    <div id="chat-header-avatar-container" class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden flex items-center justify-center text-sm font-bold">
                        <img id="chat-header-avatar" src="" class="w-full h-full object-cover hidden"><span id="chat-header-initials" class="hidden"></span>
                    </div>
                    <div>
                        <h3 id="chat-header-name" class="font-bold text-white leading-tight">Name</h3>
                        <p id="chat-header-status" class="text-xs text-green-500 font-semibold">Online</p>
                    </div>
                </div>
                <div class="relative">
                    <button onclick="document.getElementById('chat-menu').classList.toggle('hidden')" class="p-2 text-gray-600 dark:text-gray-300"><i class="fas fa-ellipsis-v"></i></button>
                    <div id="chat-menu" class="hidden absolute right-0 top-10 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-xl py-1 border dark:border-gray-600 z-40">
                        <button onclick="deleteCurrentChat()" class="w-full text-left px-4 py-3 text-red-500 hover:bg-gray-100 dark:hover:bg-gray-600 font-medium"><i class="fas fa-trash mr-2"></i> Delete Chat</button>
                    </div>
                </div>
            </div>

            <!-- SCROLLABLE MESSAGES -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20 bg-repeat bg-cover bg-center scroll-smooth"></div>

            <!-- FIXED INPUT AREA -->
            <div id="chat-input-area" class="bg-gray-800 p-3 flex items-end gap-2 border-t border-gray-700 z-30">
                <div id="reply-preview" class="hidden absolute bottom-full left-0 w-full bg-gray-800 p-2 border-l-4 border-purple-500 flex justify-between items-center border-t border-gray-700">
                    <div class="pl-2 overflow-hidden"><p class="text-xs text-purple-500 font-bold">Replying to...</p><p id="reply-text" class="text-sm text-gray-300 truncate">Message</p></div>
                    <button onclick="cancelReply()" class="p-2 text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <button onclick="triggerFileUpload()" class="p-3 text-gray-500 hover:text-purple-500 transition-colors"><i class="fas fa-paperclip text-xl"></i></button>
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFiles(this.files)">
                <div class="flex-1 bg-gray-700 rounded-2xl px-4 py-2 min-h-[45px] flex items-center">
                    <input type="text" id="msg-input" placeholder="Message" class="w-full bg-transparent outline-none text-white font-medium" onkeypress="if(event.key === 'Enter') sendMsg()">
                </div>
                <button onclick="sendMsg()" class="p-3 bg-purple-600 text-white rounded-full shadow-lg hover:opacity-90 active:scale-90 transition-transform"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- SETTINGS & MODALS -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl overflow-hidden flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                
                <!-- Profile Section -->
                <div class="flex flex-col items-center mb-8">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                        <!-- ROUNDED PROFILE PIC FIX -->
                        <div id="settings-avatar" class="w-24 h-24 rounded-full bg-purple-900 flex items-center justify-center text-purple-300 text-2xl font-bold overflow-hidden border-4 border-gray-700"></div>
                    </div>
                    <h3 id="settings-name" class="mt-3 font-bold text-xl text-white">User</h3>
                    <button onclick="document.getElementById('avatar-upload').click()" class="text-purple-400 text-sm font-bold mt-1">Change Profile Photo</button>
                </div>

                <!-- Theme Section -->
                <div class="mb-6">
                    <h4 class="font-bold text-white mb-3">Color Theme</h4>
                    <div class="grid grid-cols-4 gap-3" id="theme-selector">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Custom Wallpaper Section -->
                <div class="mb-6">
                    <h4 class="font-bold text-white mb-3">Chat Wallpaper</h4>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('bg-upload').click()" class="flex-1 py-2 bg-gray-700 rounded-lg text-sm font-bold text-white hover:bg-gray-600 transition">Upload Custom</button>
                        <button onclick="removeWallpaper()" class="px-3 py-2 bg-red-900 text-red-200 rounded-lg text-sm font-bold hover:bg-red-200 transition"><i class="fas fa-trash"></i></button>
                    </div>
                    <input type="file" id="bg-upload" class="hidden" accept="image/*" onchange="saveWallpaper(this)">
                    <p class="text-xs text-gray-500 mt-2">Upload an image from your gallery to use as background.</p>
                </div>

                <!-- Toggles -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Sound Effects</span>
                        <input type="checkbox" id="sound-toggle" checked class="toggle-checkbox" onclick="toggleSound()">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Push Notifications</span>
                        <button onclick="server.registerPush()" class="bg-purple-600 px-3 py-1 rounded text-sm font-bold hover:bg-purple-500 transition">Enable</button>
                        <input type="checkbox" id="notif-toggle" class="toggle-checkbox hidden">
                    </div>
                </div>

                <div class="border-t border-gray-700 my-6"></div>

                <!-- Actions -->
                <div class="space-y-3">
                    <button onclick="openChangePwModal()" class="w-full p-3 rounded-xl bg-gray-700 text-left font-bold text-white flex justify-between items-center">
                        Change Password
                    </button>
                    <button onclick="logout()" class="w-full p-3 rounded-xl bg-red-900 text-red-200 text-left font-bold flex justify-between items-center">
                        Log Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CHANGE PASSWORD MODAL -->
    <div id="change-pw-modal" class="hidden fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4 dark:text-white">Change Password</h3>
            <input type="password" id="cp-new" placeholder="New Password" class="w-full p-3 mb-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white outline-none font-semibold">
            <div class="flex gap-3">
                <button onclick="document.getElementById('change-pw-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg dark:text-white font-semibold">Cancel</button>
                <button onclick="saveNewPassword()" class="flex-1 py-2 bg-primary text-white rounded-lg font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- CROPPER MODAL (Reused for logic) -->
    <div id="cropper-modal" class="hidden fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-lg rounded-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 flex justify-between items-center border-b dark:border-gray-700">
                <h3 class="text-white font-bold">Adjust Photo</h3>
                <button onclick="closeCropper()" class="text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4">
                <div class="relative w-full h-64 bg-black overflow-hidden rounded-lg" id="crop-container"
                        ontouchstart="startDrag(event)" ontouchmove="drag(event)" ontouchend="endDrag()"
                        onmousedown="startDrag(event)" onmousemove="drag(event)" onmouseup="endDrag()">
                    <canvas id="crop-canvas" class="absolute top-0 left-0 origin-top-left"></canvas>
                    <div class="absolute inset-0 pointer-events-none border-[50px] border-black/60 rounded-full" style="box-shadow: 0 0 0 999px rgba(0,0,0,0.6);"></div>
                </div>
                <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1" class="w-full mt-4" oninput="updateZoom(this.value)">
                <button onclick="saveCrop()" class="w-full mt-4 bg-primary text-white py-3 rounded-lg font-bold">Save Photo</button>
            </div>
        </div>
    </div>
    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="initCropper(this)">

    <!-- MEDIA VIEWER -->
    <div id="media-viewer" class="hidden fixed inset-0 z-[80] bg-black flex flex-col justify-center items-center transition-opacity duration-300 opacity-0">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/70 to-transparent">
            <button onclick="closeMediaViewer()" class="text-white p-2"><i class="fas fa-arrow-left text-xl"></i></button>
            <div class="flex gap-4">
                <a id="download-btn" href="#" download class="text-white p-2"><i class="fas fa-download text-xl"></i></a>
            </div>
        </div>
        <div class="media-viewer-container w-full h-full flex items-center justify-center overflow-hidden"
             ontouchstart="handlePinchStart(event)" ontouchmove="handlePinchMove(event)" ontouchend="handlePinchEnd()">
            <img id="viewer-img" src="" class="hidden max-w-full max-h-full object-contain">
            <video id="viewer-video" src="" class="hidden max-w-full max-h-full" controls playsinline></video>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden fixed inset-0 z-50 bg-gray-100 dark:bg-gray-900 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 p-4 shadow-md flex justify-between sticky top-0 z-10">
            <h2 class="text-xl font-bold text-red-600">Admin Console</h2>
            <button onclick="toggleAdminPanel()" class="text-gray-500"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div class="p-4 max-w-4xl mx-auto">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6">
                <h3 class="font-bold mb-4 dark:text-white text-lg border-b dark:border-gray-700 pb-2">Create New User</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="new-user-name" placeholder="Full Name" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg dark:text-white">
                    <input type="text" id="new-user-username" placeholder="Username" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg dark:text-white">
                    <input type="text" id="new-user-pass" placeholder="Temp Password" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg dark:text-white">
                </div>
                <button onclick="adminCreateUser()" class="bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-600">Create User</button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6">
                <h3 class="font-bold mb-4 dark:text-white">Existing Users</h3>
                <div id="admin-user-list" class="space-y-3"></div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="font-bold mb-4 dark:text-white">Global Actions</h3>
                <button class="w-full bg-red-100 text-red-600 py-3 rounded-lg mb-2 font-bold" onclick="alert('All chats cleared from DB')">Clear All System Chats</button>
            </div>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="msg-context-menu" class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 rounded-t-2xl shadow-2xl z-40 context-menu p-4 pb-8">
        <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
        <button onclick="activateReply()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg dark:text-white">
            <i class="fas fa-reply text-purple-500"></i> Reply
        </button>
        <button onclick="copyMessageText()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg dark:text-white">
            <i class="fas fa-copy text-blue-500"></i> Copy Text
        </button>
        <button onclick="closeContextMenu()" class="w-full mt-2 p-3 text-center text-red-500 font-bold border rounded-lg">Cancel</button>
    </div>

    <!-- PASSWORD RESET PROMPT (For Admin) -->
    <div id="admin-pw-reset-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700">
            <h3 class="font-bold text-lg mb-4 text-white">Reset User Password</h3>
            <p class="text-sm text-gray-400 mb-4">Enter a new temporary password (4-8 chars).</p>
            <input type="text" id="admin-new-pw" placeholder="Temp Password" class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white outline-none">
            <div class="flex gap-3">
                <button onclick="document.getElementById('admin-pw-reset-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-700 text-white rounded-lg font-bold">Cancel</button>
                <button onclick="confirmAdminReset()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Reset</button>
            </div>
        </div>
    </div>

    <!-- ===================== LOGIC ===================== -->
    <script>
        // --- THEME LOGIC ---
        const themes = [
            { id: 1, name: "Electric Blue", primary: "#3B82F6", secondary: "#2563EB", darkBg: "#0F172A" },
            { id: 2, name: "Neon Purple", primary: "#8B5CF6", secondary: "#7C3AED", darkBg: "#1E1E1E" },
            { id: 3, name: "Teal Cyan", primary: "#06B6D4", secondary: "#0891B2", darkBg: "#111827" },
            { id: 4, name: "Lime Green", primary: "#A3E635", secondary: "#65A30D", darkBg: "#1F2937" }
        ];

        // Load saved theme or default to #2 (Purple)
        let currentThemeId = localStorage.getItem('sTalk_theme') ? parseInt(localStorage.getItem('sTalk_theme')) : 2;

        function applyTheme(id) {
            const theme = themes.find(t => t.id === id) || themes[1];
            currentThemeId = id;
            localStorage.setItem('sTalk_theme', id);
            
            const root = document.documentElement;
            root.style.setProperty('--theme-primary', theme.primary);
            root.style.setProperty('--theme-secondary', theme.secondary);
            root.style.setProperty('--theme-dark-bg', theme.darkBg);
            
            // Update UI Swatches
            renderThemeSelector();
        }

        function renderThemeSelector() {
            const container = document.getElementById('theme-selector');
            if(!container) return;
            container.innerHTML = themes.map(t => `
                <button onclick="applyTheme(${t.id})" 
                    class="theme-swatch w-10 h-10 rounded-full shadow-sm transition-transform hover:scale-110 focus:outline-none ring-2 ring-offset-2 dark:ring-offset-gray-800 ${currentThemeId === t.id ? 'selected' : 'ring-transparent'}" 
                    style="background-color: ${t.primary};" 
                    title="${t.name}">
                </button>
            `).join('');
        }

        // Initial Apply
        applyTheme(currentThemeId);


        // --- WALLPAPER LOGIC ---
        function saveWallpaper(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('sTalk_bg', e.target.result);
                applyWallpaper();
                showToast("Wallpaper updated!");
            };
            reader.readAsDataURL(input.files[0]);
            input.value = "";
        }

        function removeWallpaper() {
            localStorage.removeItem('sTalk_bg');
            applyWallpaper();
            showToast("Wallpaper removed!");
        }

        function applyWallpaper() {
            const bg = localStorage.getItem('sTalk_bg');
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            if(bg) {
                container.style.backgroundImage = `url('${bg}')`;
                container.style.backgroundSize = 'cover';
                container.style.backgroundPosition = 'center';
            } else {
                // Default pattern
                container.style.backgroundImage = "url('https://i.pinimg.com/originals/85/ec/df/85ecdf1c3611ecc9b7fa85282d9526e0.png')";
                container.style.backgroundSize = 'auto'; // Repeat pattern
                container.style.backgroundPosition = '0 0';
            }
        }

        // --- UTILS & HELPERS ---
        function getInitials(name) {
            return name ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
        }
        function renderAvatar(user, sizeClass="w-10 h-10", fontSize="text-base") {
            if (user.avatar && user.avatar.length > 10) {
                return `<img src="${user.avatar}" class="${sizeClass} object-cover w-full h-full">`;
            } else {
                return `<div class="${sizeClass} flex items-center justify-center ${fontSize}">${getInitials(user.name)}</div>`;
            }
        }

        // --- AUTH LOGIC ---
        function appLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            server.login(u, p).then(user => {
                if (user.mustChangePassword) {
                    alert("Security: Please change your temporary password.");
                    enterMainApp(user);
                    openChangePwModal();
                } else {
                    enterMainApp(user);
                }
            }).catch(err => alert(err));
        }

        function enterMainApp(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('view-main').classList.add('flex');
            
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            updateMyProfileUI();
            applyWallpaper(); // Apply wallpaper on login/init
            
            if(user.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            
            renderUserList();
            // Init toggle states in Settings
            document.getElementById('sound-toggle').checked = soundEnabled;
            renderThemeSelector(); // ensure swatches are rendered
        }

        function updateMyProfileUI() {
            const user = server.currentUser;
            // Sidebar
            document.getElementById('my-username').innerText = user.name;
            document.getElementById('my-avatar').innerHTML = renderAvatar(user, "w-full h-full rounded-full");
            
            // Settings Modal
            document.getElementById('settings-name').innerText = user.name;
            document.getElementById('settings-avatar').innerHTML = renderAvatar(user, "w-full h-full rounded-full", "text-3xl");
        }

        function logout() { 
            localStorage.removeItem('sTalk_user');
            window.location.reload(); 
        }

        // --- SETTINGS LOGIC ---
        function openSettingsModal() { 
            document.getElementById('settings-modal').classList.remove('hidden'); 
            renderThemeSelector();
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function toggleTheme() { 
            document.documentElement.classList.toggle('dark'); 
        }
        function toggleSound() { 
            soundEnabled = !soundEnabled; 
            localStorage.setItem('sTalk_sound', soundEnabled);
        }
        function toggleNotifications() {
            if("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission().then(p => {
                    if(p==="granted") new Notification("sTalk", { body: "Notifications Enabled!" });
                });
            }
        }

        function openChangePwModal() { document.getElementById('change-pw-modal').classList.remove('hidden'); }
        function saveNewPassword() {
            const p = document.getElementById('cp-new').value;
            if(p.length < 4) return alert("Too short");
            server.changePassword(p).then(() => {
                alert("Password changed!");
                document.getElementById('change-pw-modal').classList.add('hidden');
            });
        }

        // --- ADMIN RESET ---
        let targetResetUserId = null;
        function promptAdminReset(userId) {
            targetResetUserId = userId;
            document.getElementById('admin-pw-reset-modal').classList.remove('hidden');
        }
        function confirmAdminReset() {
            const pw = document.getElementById('admin-new-pw').value;
            if(pw.length < 4 || pw.length > 8) return alert("Password must be 4-8 chars");
            server.adminResetPassword(targetResetUserId, pw).then(res => {
                alert("Password reset successfully.");
                document.getElementById('admin-pw-reset-modal').classList.add('hidden');
                document.getElementById('admin-new-pw').value = "";
            });
        }

        // --- CROPPING LOGIC ---
        let cropCanvas, cropCtx, cropImg, cropState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false };
        
        function initCropper(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                cropImg = new Image(); cropImg.src = e.target.result;
                cropImg.onload = () => {
                    document.getElementById('cropper-modal').classList.remove('hidden');
                    closeSettingsModal(); // close settings to show cropper
                    cropCanvas = document.getElementById('crop-canvas'); 
                    cropCtx = cropCanvas.getContext('2d');
                    // Set dims
                    const container = document.getElementById('crop-container');
                    cropCanvas.width = container.offsetWidth;
                    cropCanvas.height = container.offsetHeight;
                    cropState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false }; 
                    drawCropper();
                };
            }; 
            reader.readAsDataURL(input.files[0]);
            input.value = ""; // reset
        }

        function closeCropper() {
            document.getElementById('cropper-modal').classList.add('hidden');
            openSettingsModal(); // return to settings
        }

        function drawCropper() {
            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            const w = cropImg.width * cropState.scale; 
            const h = cropImg.height * cropState.scale;
            const x = (cropCanvas.width - w)/2 + cropState.offsetX;
            const y = (cropCanvas.height - h)/2 + cropState.offsetY;
            cropCtx.drawImage(cropImg, x, y, w, h);
        }
        
        function updateZoom(val) { cropState.scale = parseFloat(val); drawCropper(); }
        function startDrag(e) { 
            cropState.isDragging = true; 
            const cx = e.touches ? e.touches[0].clientX : e.clientX; 
            const cy = e.touches ? e.touches[0].clientY : e.clientY; 
            cropState.startX = cx - cropState.offsetX; 
            cropState.startY = cy - cropState.offsetY; 
        }
        function drag(e) { 
            if (!cropState.isDragging) return; 
            e.preventDefault(); 
            const cx = e.touches ? e.touches[0].clientX : e.clientX; 
            const cy = e.touches ? e.touches[0].clientY : e.clientY; 
            cropState.offsetX = cx - cropState.startX; 
            cropState.offsetY = cy - cropState.startY; 
            drawCropper(); 
        }
        function endDrag() { cropState.isDragging = false; }

        function saveCrop() {
            const sc = document.createElement('canvas'); sc.width = 200; sc.height = 200;
            sc.getContext('2d').drawImage(cropCanvas, (cropCanvas.width/2 - 100), (cropCanvas.height/2 - 100), 200, 200, 0, 0, 200, 200);
            server.updateUser({ avatar: sc.toDataURL() });
            closeCropper();
        }

        // --- APP CORE & ADMIN ---
        function adminCreateUser() {
            const name = document.getElementById('new-user-name').value;
            const user = document.getElementById('new-user-username').value;
            const pass = document.getElementById('new-user-pass').value;
            if(!name || !user || !pass) return alert("Fill all fields");
            server.createAccount(name, user, pass);
            renderUserList();
            alert(`User ${user} created!`);
        }

        function renderUserList() {
            // Regular list
            const list = document.getElementById('user-list');
            const others = server.users.filter(u => u.id !== server.currentUser.id);
            list.innerHTML = others.map(u => `
                <div onclick="openChat(${u.id})" ontouchstart="openChat(${u.id})" class="p-4 flex items-center gap-3 hover:bg-gray-800 cursor-pointer border-b border-gray-700 dark:border-gray-700 transition-colors ${server.currentUser.unread && server.currentUser.unread[u.id] > 0 ? 'highlight-user' : ''}">
                    <div class="relative w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center font-bold border border-gray-600 dark:border-gray-600">
                        ${renderAvatar(u, "w-full h-full rounded-full", "text-lg")}
                        ${u.status === 'online' ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800 dark:border-gray-800"></div>' : ''}
                        ${(server.currentUser.unread && server.currentUser.unread[u.id] > 0) ? 
                            `<div class="unread-badge absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center shadow-md">${server.currentUser.unread[u.id]}</div>` : ''}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between"><h3 class="font-bold text-white ${server.currentUser.unread && server.currentUser.unread[u.id] > 0 ? 'italic' : ''}">${u.name}</h3></div>
                        <p class="text-sm text-gray-400 truncate">${(server.currentUser.unread && server.currentUser.unread[u.id] > 0) ? 'New messages' : 'Tap to chat'}</p>
                    </div>
                </div>
            `).join('');
            
            // Admin list
            const adminList = document.getElementById('admin-user-list');
            adminList.innerHTML = server.users.map(u => `
                <div class="flex items-center justify-between p-3 bg-gray-700 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold overflow-hidden">
                             ${renderAvatar(u, "w-full h-full rounded-full", "text-xs")}
                        </div>
                        <div><span class="dark:text-white font-medium block">${u.name}</span><span class="text-xs text-gray-400">${u.role}</span></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="promptAdminReset(${u.id})" class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">Reset PW</button>
                        ${u.id !== server.currentUser.id ? `<button onclick="if(confirm('Delete user?')){server.deleteUser(${u.id})}" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleAdminPanel() { document.getElementById('admin-panel').classList.toggle('hidden'); }

        // --- CHAT LOGIC ---
        function openChat(userId) {
            activeChatId = userId;
            const user = server.users.find(u => u.id === userId);
            document.getElementById('chat-header-name').innerText = user.name;
            
            const imgEl = document.getElementById('chat-header-avatar');
            const txtEl = document.getElementById('chat-header-initials');
            if(user.avatar && user.avatar.length > 10) {
                imgEl.src = user.avatar; imgEl.classList.remove('hidden'); txtEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden'); txtEl.classList.remove('hidden'); txtEl.innerText = getInitials(user.name);
            }

            document.getElementById('chat-header-status').innerText = user.status === 'online' ? 'Online' : `Last seen: ${user.lastSeen}`;
            
            // MOBILE FIX: Force remove translate on open
            document.getElementById('chat-interface').classList.remove('translate-x-full');
            
            server.loadMessages(userId);
            server.markRead(userId);
            applyWallpaper();
        }

        function closeChat() {
            activeChatId = null;
            // MOBILE FIX: Force add translate on close
            document.getElementById('chat-interface').classList.add('translate-x-full');
        }

        function updateUI() {
            if (!activeChatId) return;
            const roomId = getChatRoomId(server.currentUser.id, activeChatId);
            const msgs = server.chats[roomId] || [];
            const container = document.getElementById('messages-container');
            
            container.innerHTML = msgs.map(msg => {
                const isSelf = msg.senderId === server.currentUser.id;
                const align = isSelf ? 'justify-end' : 'justify-start';
                const bg = isSelf ? 'msg-bubble-self' : 'msg-bubble-other';
                
                // TICKS LOGIC
                let tick = '<i class="fas fa-check text-gray-400 text-[10px]"></i>'; // Sent
                if(msg.status === 'delivered') tick = '<i class="fas fa-check-double text-gray-400 text-[10px]"></i>';
                if(msg.status === 'read') tick = '<i class="fas fa-check-double tick-read text-[10px]"></i>';
                
                let contentHtml = `<p class="text-sm md:text-base">${msg.text}</p>`;
                if(msg.type === 'image') {
                    contentHtml = `<img src="${msg.fileData}" class="max-w-[200px] rounded-lg cursor-pointer mb-1" onclick="openMediaViewer('${msg.fileData}', 'image')">`;
                } else if (msg.type === 'video') {
                    contentHtml = `<div class="relative max-w-[200px] cursor-pointer" onclick="openMediaViewer('${msg.fileData}', 'video')"><video src="${msg.fileData}" class="rounded-lg w-full"></video><div class="absolute inset-0 flex items-center justify-center bg-black/30 rounded-lg"><i class="fas fa-play text-white text-2xl"></i></div></div>`;
                }
                
                return `<div class="flex ${align} mb-2" oncontextmenu="event.preventDefault(); showMsgOptions('${msg.id}')" onmousedown="startLongPress('${msg.id}')" onmouseup="cancelLongPress()" ontouchstart="startLongPress('${msg.id}')" ontouchend="cancelLongPress()"><div class="${bg} p-3 max-w-[75%] shadow-sm relative">${contentHtml}<div class="text-[10px] flex justify-end gap-1 opacity-70 mt-1"><span>${new Date(msg.sentAt).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>${isSelf?tick:''}</div></div></div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;
            server.sendMessage(activeChatId, txt).then(() => { input.value = ''; });
        }
    </script>
</body>
</html>