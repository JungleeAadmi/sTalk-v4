<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>sTalk - Secure Chat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1F2937">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="apple-touch-icon" href="logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Socket.IO Library -->
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        :root {
            --theme-primary: #8B5CF6;
            --theme-secondary: #3B82F6;
            --theme-dark-bg: #1E1E1E;
            --primary-grad: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
        }
        body { font-family: 'Nunito', sans-serif; overscroll-behavior-y: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .msg-bubble-self { background: var(--primary-grad); color: white; border-radius: 20px 20px 4px 20px; }
        .msg-bubble-other { background-color: #374151; color: #f3f4f6; border-radius: 20px 20px 20px 4px; }
        .tick { transition: all 0.2s ease; }
        .tick-read { color: #60A5FA; } 
        .toggle-checkbox:checked { right: 0; border-color: var(--theme-primary); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--theme-primary); }
        .theme-swatch.selected { outline: 3px solid var(--theme-primary); outline-offset: 2px; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Nunito', 'sans-serif'] }, colors: { primary: 'var(--theme-primary)', themeDarkBg: 'var(--theme-dark-bg)', dark: '#111827' } } } }
    </script>
</head>
<!-- FORCED DARK MODE DEFAULT -->
<body class="bg-gray-900 dark text-white h-screen overflow-hidden flex flex-col transition-colors duration-300 select-none font-sans">

    <!-- ===================== API CLIENT ===================== -->
    <script>
        // Initialize socket only if io is available
        let socket;
        if (typeof io !== 'undefined') {
            socket = io();
        } else {
            console.error("Socket.io library not loaded. Real-time features will not work.");
            // Create a dummy socket object to prevent crashes
            socket = {
                on: () => {},
                emit: () => {}
            };
        }
        
        class APIClient {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.chats = {};
                
                // Listen for global updates
                socket.on('users_update', (users) => {
                    this.users = users;
                    renderUserList();
                });
                
                socket.on('message_received', (msg) => {
                    // If this message belongs to the active chat, show it
                    if (activeChatId && (msg.senderId === activeChatId || msg.senderId === this.currentUser.id)) {
                        // Avoid duplicates
                        if (!this.chats[getChatRoomId(this.currentUser.id, activeChatId)]?.find(m => m.id === msg.id)) {
                            this.addMessageToLocal(msg);
                            updateUI();
                            if(msg.senderId !== this.currentUser.id) playNotificationSound();
                        }
                    }
                });
                
                socket.on('chats_cleared', () => {
                    this.chats = {};
                    updateUI();
                    alert("Admin cleared all chats.");
                });
            }

            async login(username, password) {
                try {
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    if (!res.ok) throw new Error('Login failed');
                    const data = await res.json();
                    if (data.success) {
                        this.currentUser = data.user;
                        this.fetchUsers();
                        return data.user;
                    } else {
                        throw data.message;
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    // Fallback for demo environment without backend
                    if (username === 'admin' && password === 'admin') {
                         this.currentUser = { id: 1, username: "admin", name: "System Admin", avatar: "", role: "admin" };
                         this.fetchUsers();
                         return this.currentUser;
                    }
                    throw error;
                }
            }

            async fetchUsers() {
                try {
                    const res = await fetch('/api/users');
                    if (!res.ok) throw new Error('Fetch users failed');
                    this.users = await res.json();
                    renderUserList();
                } catch (error) {
                    console.error("Fetch users error:", error);
                    // Mock data for demo
                    this.users = [
                        { id: 1, username: "admin", name: "System Admin", role: "admin", status: "online" },
                        { id: 2, username: "alice", name: "Alice", role: "user", status: "offline" },
                        { id: 3, username: "bob", name: "Bob", role: "user", status: "offline" }
                    ];
                    renderUserList();
                }
            }

            async createUser(name, username, password) {
                try {
                    const res = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, username, password })
                    });
                    return await res.json();
                } catch (error) {
                    console.error("Create user error:", error);
                    return { success: false, message: "Network error" };
                }
            }

            async changePassword(newPassword) {
                try {
                    const res = await fetch(`/api/users/${this.currentUser.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: newPassword })
                    });
                    this.currentUser.mustChangePassword = false;
                    return await res.json();
                } catch (error) {
                     console.error("Change password error:", error);
                     return { success: false };
                }
            }
            
            async adminResetPassword(targetUserId, newTempPass) {
                try {
                    const res = await fetch('/api/admin/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: targetUserId, newPassword: newTempPass })
                    });
                    return await res.json();
                } catch (error) {
                    console.error("Admin reset password error:", error);
                    return { success: false };
                }
            }
            
            async deleteUser(id) {
                try {
                    await fetch(`/api/users/${id}`, { method: 'DELETE' });
                    this.fetchUsers();
                } catch (error) {
                    console.error("Delete user error:", error);
                }
            }

            async sendMessage(otherUserId, content, type='text', fileData=null, replyTo=null) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                
                const msg = {
                    id: 'm' + Date.now(),
                    chatId: roomId,
                    senderId: this.currentUser.id,
                    text: content,
                    type, fileData, replyTo,
                    sentAt: new Date().toISOString(),
                    status: 'sent'
                };

                // Optimistic UI update
                this.addMessageToLocal(msg);
                updateUI();

                try {
                    const res = await fetch('/api/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chatId: roomId, message: msg })
                    });
                    return await res.json();
                } catch (error) {
                    console.error("Send message error:", error);
                    return { success: false };
                }
            }
            
            async loadMessages(otherUserId) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                socket.emit('join_room', roomId); // Join socket room
                
                try {
                    const res = await fetch(`/api/chats/${otherUserId}?chatId=${roomId}`);
                    if (!res.ok) throw new Error('Load messages failed');
                    const history = await res.json();
                    this.chats[roomId] = history;
                    updateUI();
                } catch (error) {
                    console.error("Load messages error:", error);
                    this.chats[roomId] = []; // Empty chat on error
                    updateUI();
                }
            }
            
            addMessageToLocal(msg) {
                const roomId = msg.chatId;
                if (!this.chats[roomId]) this.chats[roomId] = [];
                this.chats[roomId].push(msg);
            }
        }

        // Helper to create consistent Room ID (smaller_ID-larger_ID)
        function getChatRoomId(id1, id2) {
            return [id1, id2].sort().join('_');
        }

        const server = new APIClient();
        let activeChatId = null;
        let replyContext = null;
        
        // Audio Context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;
        function playNotificationSound() {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(1200, t); o.frequency.exponentialRampToValueAtTime(800, t + 0.1);
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
            o.start(t); o.stop(t + 1.5);
        }
    </script>

    <!-- ===================== VIEWS ===================== -->

    <!-- 1. LOGIN -->
    <div id="view-login" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-gray-700">
            <img src="logo.svg" class="w-24 h-24 mx-auto mb-6 rounded-[20px] shadow-lg" onerror="this.style.display='none'">
            <!-- Fallback inline SVG if logo.svg fails to load -->
            <div class="w-24 h-24 mx-auto mb-6 rounded-[20px] shadow-lg overflow-hidden bg-gray-900" id="fallback-logo" style="display: none;">
                <svg width="100%" height="100%" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="512" height="512" fill="#1F2937"/>
                    <defs>
                        <linearGradient id="grad1-i" x1="100" y1="100" x2="400" y2="400" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#8B5CF6" />
                            <stop offset="100%" stop-color="#3B82F6" />
                        </linearGradient>
                    </defs>
                    <path d="M256 112C167.6 112 96 176.5 96 256C96 301.5 119.5 342.1 156.6 368.1C152.9 383.9 142.5 406.5 122.6 423.2C119.5 425.8 119.7 430.7 123.1 433C154.9 454.8 196.6 444.8 214.8 438.6C228.1 442.8 241.9 445.1 256.2 445.1C344.6 445.1 416 380.6 416 301.1C416 221.6 344.4 157.1 256 157.1V112Z" fill="url(#grad1-i)"/>
                    <circle cx="190" cy="256" r="25" fill="white" fill-opacity="0.9"/>
                    <circle cx="256" cy="256" r="25" fill="white" fill-opacity="0.9"/>
                    <circle cx="322" cy="256" r="25" fill="white" fill-opacity="0.9"/>
                </svg>
            </div>
            <script>
                document.querySelector('img[src="logo.svg"]').onerror = function() {
                    this.style.display = 'none';
                    document.getElementById('fallback-logo').style.display = 'block';
                };
            </script>

            <h1 class="text-2xl font-extrabold text-white mb-2">sTalk Login</h1>
            <input type="text" id="login-user" placeholder="Username" class="w-full p-4 rounded-xl bg-gray-700 text-white border-none focus:ring-2 focus:ring-purple-500 mb-3 outline-none font-semibold">
            <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-700 text-white border-none focus:ring-2 focus:ring-purple-500 mb-4 outline-none font-semibold">
            <button onclick="appLogin()" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-purple-600 to-blue-500 text-white font-bold shadow-lg active:scale-95 transition-transform">Login</button>
        </div>
    </div>

    <!-- 2. MAIN -->
    <div id="view-main" class="hidden flex-1 flex overflow-hidden relative bg-gray-900 text-white">
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-80 lg:w-96 bg-gray-800 border-r border-gray-700 flex flex-col z-10">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openSettingsModal()">
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-purple-900 flex items-center justify-center text-purple-300 font-bold overflow-hidden border border-gray-700"></div>
                    <h2 id="my-username" class="font-bold text-white text-lg">User</h2>
                </div>
                <div class="flex gap-3">
                    <button id="admin-btn" onclick="toggleAdminPanel()" class="hidden w-8 h-8 rounded-full bg-red-900 text-red-200 flex items-center justify-center"><i class="fas fa-shield-alt"></i></button>
                    <button onclick="openSettingsModal()" class="w-8 h-8 rounded-full bg-gray-700 text-gray-300 flex items-center justify-center transition-colors hover:bg-gray-600"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="p-3">
                <div class="bg-gray-700 rounded-lg flex items-center px-3 py-2">
                    <i class="fas fa-search text-gray-400 mr-2"></i>
                    <input type="text" placeholder="Search" class="bg-transparent w-full outline-none text-white font-medium">
                </div>
            </div>
            <div id="user-list" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- CHAT -->
        <div id="chat-interface" class="flex-1 bg-gray-900 flex flex-col absolute inset-0 md:static transform translate-x-full md:translate-x-0 transition-transform duration-300 z-20">
            <div class="bg-gray-800 p-3 border-b border-gray-700 flex items-center justify-between shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="md:hidden text-gray-300 p-2"><i class="fas fa-arrow-left text-xl"></i></button>
                    <div id="chat-header-avatar-container" class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden flex items-center justify-center text-sm font-bold">
                        <img id="chat-header-avatar" src="" class="w-full h-full object-cover hidden"><span id="chat-header-initials" class="hidden"></span>
                    </div>
                    <div>
                        <h3 id="chat-header-name" class="font-bold text-white leading-tight">Name</h3>
                        <p id="chat-header-status" class="text-xs text-green-500 font-semibold">Online</p>
                    </div>
                </div>
                <div class="relative">
                    <button onclick="document.getElementById('chat-menu').classList.toggle('hidden')" class="p-2 text-gray-600 dark:text-gray-300">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div id="chat-menu" class="hidden absolute right-0 top-10 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-xl py-1 border dark:border-gray-600">
                        <button onclick="deleteCurrentChat()" class="w-full text-left px-4 py-3 text-red-500 hover:bg-gray-100 dark:hover:bg-gray-600 font-medium">
                            <i class="fas fa-trash mr-2"></i> Delete Chat
                        </button>
                    </div>
                </div>
            </div>
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20 bg-repeat bg-cover bg-center"></div>
            <div id="reply-preview" class="hidden bg-gray-800 p-2 border-l-4 border-purple-500 flex justify-between items-center mx-2 rounded-t-lg">
                <div class="pl-2 overflow-hidden">
                    <p class="text-xs text-purple-500 font-bold">Replying to...</p>
                    <p id="reply-text" class="text-sm text-gray-300 truncate">Message</p>
                </div>
                <button onclick="cancelReply()" class="p-2 text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-gray-800 p-3 flex items-end gap-2 border-t border-gray-700">
                <button onclick="triggerFileUpload()" class="p-3 text-gray-500 hover:text-purple-500 transition-colors"><i class="fas fa-paperclip text-xl"></i></button>
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFiles(this.files)">
                <div class="flex-1 bg-gray-700 rounded-2xl px-4 py-2 min-h-[45px] flex items-center">
                    <input type="text" id="msg-input" placeholder="Message" class="w-full bg-transparent outline-none text-white font-medium" onkeypress="if(event.key === 'Enter') sendMsg()">
                </div>
                <button onclick="sendMsg()" class="p-3 bg-purple-600 text-white rounded-full shadow-lg hover:opacity-90 active:scale-90 transition-transform"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden fixed inset-0 z-50 bg-gray-900 overflow-y-auto">
        <div class="bg-gray-800 p-4 shadow-md flex justify-between sticky top-0 z-10">
            <h2 class="text-xl font-bold text-red-500">Admin Console</h2>
            <button onclick="toggleAdminPanel()" class="text-gray-500"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div class="p-4 max-w-4xl mx-auto">
            <div class="bg-gray-800 rounded-xl shadow p-6 mb-6 border border-gray-700">
                <h3 class="font-bold mb-4 text-white text-lg border-b border-gray-700 pb-2">Create New User</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="new-user-name" placeholder="Full Name" class="p-3 bg-gray-700 rounded-lg text-white">
                    <input type="text" id="new-user-username" placeholder="Username" class="p-3 bg-gray-700 rounded-lg text-white">
                    <input type="text" id="new-user-pass" placeholder="Temp Password" class="p-3 bg-gray-700 rounded-lg text-white">
                </div>
                <button onclick="adminCreateUser()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-500">Create User</button>
            </div>
            <div class="bg-gray-800 rounded-xl shadow p-6 mb-6 border border-gray-700">
                <h3 class="font-bold mb-4 text-white">Existing Users</h3>
                <div id="admin-user-list" class="space-y-3"></div>
            </div>
            <div class="bg-gray-800 rounded-xl shadow p-6 border border-gray-700">
                <h3 class="font-bold mb-4 text-white">Global Actions</h3>
                <button class="w-full bg-red-900 text-red-200 py-3 rounded-lg mb-2 font-bold" onclick="if(confirm('Clear ALL chats?')){server.fetch('/api/admin/clear-chats', {method:'POST'})}">Clear All System Chats</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS & MODALS -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl overflow-hidden flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex flex-col items-center mb-8">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                        <div id="settings-avatar" class="w-24 h-24 rounded-full bg-purple-900 flex items-center justify-center text-purple-300 text-2xl font-bold overflow-hidden border-4 border-gray-700"></div>
                    </div>
                    <h3 id="settings-name" class="mt-3 font-bold text-xl text-white">User</h3>
                    <button onclick="document.getElementById('avatar-upload').click()" class="text-purple-400 text-sm font-bold mt-1">Change Profile Photo</button>
                </div>
                <div class="mb-6">
                    <h4 class="font-bold text-white mb-3">Color Theme</h4>
                    <div class="grid grid-cols-4 gap-3" id="theme-selector"></div>
                </div>
                <div class="mb-6">
                    <h4 class="font-bold text-white mb-3">Chat Wallpaper</h4>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('bg-upload').click()" class="flex-1 py-2 bg-gray-700 rounded-lg text-sm font-bold text-white hover:bg-gray-600">Upload</button>
                        <button onclick="removeWallpaper()" class="px-3 py-2 bg-red-900 text-red-200 rounded-lg text-sm font-bold"><i class="fas fa-trash"></i></button>
                    </div>
                    <input type="file" id="bg-upload" class="hidden" accept="image/*" onchange="saveWallpaper(this)">
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Sound Effects</span>
                        <input type="checkbox" id="sound-toggle" checked class="toggle-checkbox" onclick="soundEnabled = !soundEnabled">
                    </div>
                </div>
                <div class="border-t border-gray-700 my-6"></div>
                <div class="space-y-3">
                    <button onclick="openChangePwModal()" class="w-full p-3 rounded-xl bg-gray-700 text-left font-bold text-white">Change Password</button>
                    <button onclick="logout()" class="w-full p-3 rounded-xl bg-red-900 text-red-200 text-left font-bold">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PASSWORD RESET PROMPT (For Admin) -->
    <div id="admin-pw-reset-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700">
            <h3 class="font-bold text-lg mb-4 text-white">Reset User Password</h3>
            <p class="text-sm text-gray-400 mb-4">Enter a new temporary password (4-8 chars).</p>
            <input type="text" id="admin-new-pw" placeholder="Temp Password" class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white outline-none">
            <div class="flex gap-3">
                <button onclick="document.getElementById('admin-pw-reset-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-700 text-white rounded-lg font-bold">Cancel</button>
                <button onclick="confirmAdminReset()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Reset</button>
            </div>
        </div>
    </div>

    <!-- USER CHANGE PW MODAL -->
    <div id="change-pw-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-sm border border-gray-700">
            <h3 class="font-bold text-lg mb-4 text-white">Change Password</h3>
            <input type="password" id="cp-new" placeholder="New Password" class="w-full p-3 mb-3 rounded-lg bg-gray-700 text-white outline-none">
            <button onclick="saveNewPassword()" class="w-full py-2 bg-purple-600 text-white rounded-lg font-bold">Save</button>
        </div>
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="initCropper(this)">

    <!-- ===================== LOGIC ===================== -->
    <script>
        // --- THEMES ---
        const themes = [
            { id: 1, name: "Electric Blue", primary: "#3B82F6", secondary: "#2563EB", darkBg: "#0F172A" },
            { id: 2, name: "Neon Purple", primary: "#8B5CF6", secondary: "#7C3AED", darkBg: "#1E1E1E" },
            { id: 3, name: "Teal Cyan", primary: "#06B6D4", secondary: "#0891B2", darkBg: "#111827" },
            { id: 4, name: "Lime Green", primary: "#A3E635", secondary: "#65A30D", darkBg: "#1F2937" }
        ];
        let currentThemeId = localStorage.getItem('sTalk_theme') ? parseInt(localStorage.getItem('sTalk_theme')) : 2;

        function applyTheme(id) {
            const theme = themes.find(t => t.id === id) || themes[1];
            currentThemeId = id;
            localStorage.setItem('sTalk_theme', id);
            document.documentElement.style.setProperty('--theme-primary', theme.primary);
            document.documentElement.style.setProperty('--theme-secondary', theme.secondary);
            document.documentElement.style.setProperty('--theme-dark-bg', theme.darkBg);
            renderThemeSelector();
        }

        function renderThemeSelector() {
            const container = document.getElementById('theme-selector');
            if(!container) return;
            container.innerHTML = themes.map(t => `
                <button onclick="applyTheme(${t.id})" class="theme-swatch w-10 h-10 rounded-full shadow-sm ring-2 ring-offset-2 ring-offset-gray-800 ${currentThemeId === t.id ? 'ring-white' : 'ring-transparent'}" style="background-color: ${t.primary};"></button>
            `).join('');
        }
        applyTheme(currentThemeId);

        // --- AUTH & APP ---
        function appLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            server.login(u, p).then(user => {
                if (user.mustChangePassword) {
                    alert("Security: Please change your password.");
                    enterMainApp(user);
                    openChangePwModal();
                } else {
                    enterMainApp(user);
                }
            }).catch(err => alert(err));
        }

        function enterMainApp(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('view-main').classList.add('flex');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            updateMyProfileUI();
            applyWallpaper();
            if(user.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            server.fetchUsers(); // Trigger load
        }

        function updateMyProfileUI() {
            const user = server.currentUser;
            document.getElementById('my-username').innerText = user.name;
            document.getElementById('my-avatar').innerHTML = renderAvatar(user, "w-full h-full");
            document.getElementById('settings-name').innerText = user.name;
            document.getElementById('settings-avatar').innerHTML = renderAvatar(user, "w-full h-full", "text-3xl");
        }

        function logout() { window.location.reload(); }

        // --- ADMIN RESET ---
        let targetResetUserId = null;
        function promptAdminReset(userId) {
            targetResetUserId = userId;
            document.getElementById('admin-pw-reset-modal').classList.remove('hidden');
        }
        function confirmAdminReset() {
            const pw = document.getElementById('admin-new-pw').value;
            if(pw.length < 4 || pw.length > 8) return alert("Password must be 4-8 chars");
            server.adminResetPassword(targetResetUserId, pw).then(res => {
                alert("Password reset successfully.");
                document.getElementById('admin-pw-reset-modal').classList.add('hidden');
                document.getElementById('admin-new-pw').value = "";
            });
        }

        // --- WALLPAPER ---
        function saveWallpaper(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => { localStorage.setItem('sTalk_bg', e.target.result); applyWallpaper(); };
            reader.readAsDataURL(input.files[0]);
        }
        function removeWallpaper() { localStorage.removeItem('sTalk_bg'); applyWallpaper(); }
        function applyWallpaper() {
            const bg = localStorage.getItem('sTalk_bg');
            const c = document.getElementById('messages-container');
            if (!c) return;
            if(bg) { c.style.backgroundImage = `url('${bg}')`; c.style.backgroundSize = 'cover'; }
            else { c.style.backgroundImage = "url('https://i.pinimg.com/originals/85/ec/df/85ecdf1c3611ecc9b7fa85282d9526e0.png')"; c.style.backgroundSize = 'auto'; }
        }

        // --- HELPERS ---
        function getInitials(name) { return name ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?'; }
        function renderAvatar(user, sizeClass, fontSize="text-base") {
            if (user.avatar && user.avatar.length > 10) return `<img src="${user.avatar}" class="${sizeClass} object-cover w-full h-full">`;
            return `<div class="${sizeClass} flex items-center justify-center ${fontSize}">${getInitials(user.name)}</div>`;
        }

        // --- ADMIN ---
        function adminCreateUser() {
            const n = document.getElementById('new-user-name').value;
            const u = document.getElementById('new-user-username').value;
            const p = document.getElementById('new-user-pass').value;
            if(!n || !u || !p) return alert("Fill all fields");
            server.createUser(n, u, p).then(res => {
                if(res.success) alert("User created!");
                else alert(res.message);
            });
        }

        function renderUserList() {
            const list = document.getElementById('user-list');
            const others = server.users.filter(u => u.id !== server.currentUser.id);
            list.innerHTML = others.map(u => `
                <div onclick="openChat(${u.id})" class="p-4 flex items-center gap-3 hover:bg-gray-800 cursor-pointer border-b border-gray-700">
                    <div class="relative w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center font-bold border border-gray-600">
                        ${renderAvatar(u, "w-full h-full", "text-lg")}
                        ${u.status === 'online' ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800"></div>' : ''}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between"><h3 class="font-bold text-white">${u.name}</h3></div>
                        <p class="text-sm text-gray-400">Tap to chat</p>
                    </div>
                </div>
            `).join('');

            // Admin List
            const adList = document.getElementById('admin-user-list');
            adList.innerHTML = server.users.map(u => `
                <div class="flex justify-between p-3 bg-gray-700 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold overflow-hidden">${renderAvatar(u, "w-full h-full", "text-xs")}</div>
                        <div><span class="text-white font-bold block">${u.name}</span><span class="text-xs text-gray-400">${u.role}</span></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="promptAdminReset(${u.id})" class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">Reset PW</button>
                        ${u.id !== server.currentUser.id ? `<button onclick="if(confirm('Delete user?')){server.deleteUser(${u.id})}" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // --- UI ACTIONS ---
        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); renderThemeSelector(); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function toggleAdminPanel() { document.getElementById('admin-panel').classList.toggle('hidden'); }
        function openChangePwModal() { document.getElementById('change-pw-modal').classList.remove('hidden'); }
        function saveNewPassword() {
            const p = document.getElementById('cp-new').value;
            if(p.length < 4) return alert("Too short");
            server.changePassword(p).then(() => {
                alert("Password changed!");
                document.getElementById('change-pw-modal').classList.add('hidden');
            });
        }

        // --- CHAT ---
        function openChat(userId) {
            activeChatId = userId;
            const user = server.users.find(u => u.id === userId);
            document.getElementById('chat-header-name').innerText = user.name;
            const img = document.getElementById('chat-header-avatar');
            const txt = document.getElementById('chat-header-initials');
            if(user.avatar && user.avatar.length > 10) { img.src=user.avatar; img.classList.remove('hidden'); txt.classList.add('hidden'); }
            else { img.classList.add('hidden'); txt.classList.remove('hidden'); txt.innerText = getInitials(user.name); }
            document.getElementById('chat-header-status').innerText = user.status === 'online' ? 'Online' : `Last seen: ${user.lastSeen}`;
            
            // MOBILE SLIDE
            if(window.innerWidth < 768) document.getElementById('chat-interface').classList.remove('translate-x-full');
            
            server.loadMessages(userId);
            applyWallpaper();
        }

        function closeChat() {
            activeChatId = null;
            if(window.innerWidth < 768) document.getElementById('chat-interface').classList.add('translate-x-full');
        }

        function updateUI() {
            if (!activeChatId) return;
            const roomId = getChatRoomId(server.currentUser.id, activeChatId);
            const msgs = server.chats[roomId] || [];
            const container = document.getElementById('messages-container');
            
            container.innerHTML = msgs.map(msg => {
                const isSelf = msg.senderId === server.currentUser.id;
                const align = isSelf ? 'justify-end' : 'justify-start';
                const bg = isSelf ? 'msg-bubble-self' : 'msg-bubble-other';
                let tick = '<i class="fas fa-check text-gray-400 text-[10px]"></i>';
                if(msg.status === 'delivered') tick = '<i class="fas fa-check-double text-gray-400 text-[10px]"></i>';
                
                let content = `<p class="text-sm md:text-base">${msg.text}</p>`;
                if(msg.type === 'image') content = `<img src="${msg.fileData}" class="max-w-[200px] rounded-lg mb-1">`;
                
                return `<div class="flex ${align}"><div class="${bg} p-3 max-w-[75%] shadow-sm relative">${content}<div class="text-[10px] flex justify-end gap-1 opacity-70 mt-1"><span>${new Date(msg.sentAt).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>${isSelf?tick:''}</div></div></div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;
            server.sendMessage(activeChatId, txt).then(() => { input.value = ''; });
        }
    </script>
</body>
</html>