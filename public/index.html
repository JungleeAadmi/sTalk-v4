<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>sTalk - Secure Chat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1F2937">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="apple-touch-icon" href="logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        :root {
            --theme-primary: #8B5CF6;
            --theme-secondary: #3B82F6;
            --theme-dark-bg: #1E1E1E;
            --primary-grad: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
        }

        /* LAYOUT FIXES FOR KEYBOARD SCROLLING */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent body scroll */
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
        }
        
        /* The main app container fills the screen */
        #view-main {
            height: 100dvh; /* Use dynamic viewport height */
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* Chat Interface: Flex Column */
        #chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Header: Fixed, no shrink */
        #chat-header {
            flex: 0 0 64px; /* Fixed height */
            z-index: 20;
        }

        /* Messages: Takes remaining space, scrollable */
        #messages-container {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }

        /* Input: Fixed, no shrink, stays at bottom */
        #chat-input-area {
            flex: 0 0 auto;
            z-index: 20;
            padding-bottom: env(safe-area-inset-bottom); /* iPhone X+ fix */
        }

        /* Other Styles */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .msg-bubble-self { background: var(--primary-grad); color: white; border-radius: 20px 20px 4px 20px; }
        .msg-bubble-other { background-color: #374151; color: #f3f4f6; border-radius: 20px 20px 20px 4px; }
        .toggle-checkbox:checked { right: 0; border-color: var(--theme-primary); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--theme-primary); }
        .theme-swatch.selected { outline: 3px solid var(--theme-primary); outline-offset: 2px; }
        .unread-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Nunito', 'sans-serif'] }, colors: { primary: 'var(--theme-primary)', themeDarkBg: 'var(--theme-dark-bg)', dark: '#111827' } } } }
    </script>
</head>
<body class="bg-gray-900 dark text-white">

    <!-- API & LOGIC -->
    <script>
        let socket;
        if (typeof io !== 'undefined') socket = io();
        else { console.error("Socket.io missing"); socket = { on:()=>{}, emit:()=>{} }; }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        class APIClient {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.chats = {};
                
                socket.on('users_update', (users) => {
                    this.users = users;
                    renderUserList();
                });
                
                socket.on('message_received', (msg) => {
                    if (activeChatId && (msg.senderId === activeChatId || msg.senderId === this.currentUser.id)) {
                        if (!this.chats[getChatRoomId(this.currentUser.id, activeChatId)]?.find(m => m.id === msg.id)) {
                            this.addMessageToLocal(msg);
                            updateUI();
                            if(msg.senderId === activeChatId) this.markRead(activeChatId);
                        }
                    }
                    if(msg.senderId !== this.currentUser.id) playNotificationSound();
                });
                
                socket.on('chats_cleared', () => { this.chats = {}; updateUI(); alert("Admin cleared chats."); });
            }

            // FIXED: ADDED MISSING UPDATE USER FUNCTION
            async updateUser(data) {
                try {
                    const res = await fetch(`/api/users/${this.currentUser.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        // Update local state
                        if(data.avatar) this.currentUser.avatar = data.avatar;
                        localStorage.setItem('sTalk_user', JSON.stringify(this.currentUser));
                        updateMyProfileUI();
                    }
                } catch (e) { console.error(e); }
            }

            async registerPush() {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) return alert("Push not supported");
                
                try {
                    const reg = await navigator.serviceWorker.ready;
                    const keyRes = await fetch('/api/push/key');
                    const { publicKey } = await keyRes.json();
                    
                    const sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });
                    
                    await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: this.currentUser.id, subscription: sub })
                    });
                    alert("Notifications enabled!");
                } catch (err) {
                    console.error(err);
                    alert("Failed to enable notifications. Ensure you added to Home Screen.");
                }
            }

            async login(username, password) {
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
                const data = await res.json();
                if (data.success) {
                    this.currentUser = data.user;
                    localStorage.setItem('sTalk_user', JSON.stringify(data.user));
                    this.fetchUsers();
                    return data.user;
                } else throw data.message;
            }
            
            async checkAuth() {
                const stored = localStorage.getItem('sTalk_user');
                if(stored) {
                    this.currentUser = JSON.parse(stored);
                    this.fetchUsers();
                    return true;
                }
                return false;
            }

            async fetchUsers() {
                const res = await fetch('/api/users');
                this.users = await res.json();
                renderUserList();
            }
            
            async markRead(senderId) {
                await fetch('/api/chats/read', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: this.currentUser.id, senderId }) });
            }

            async sendMessage(otherUserId, content, type='text', fileData=null, replyTo=null) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                const msg = { id: 'm' + Date.now(), chatId: roomId, senderId: this.currentUser.id, text: content, type, fileData, replyTo, sentAt: new Date().toISOString(), status: 'sent' };
                this.addMessageToLocal(msg);
                updateUI();
                try {
                    await fetch('/api/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chatId: roomId, message: msg, recipientId: otherUserId }) });
                } catch (e) { console.error(e); }
            }
            
            async loadMessages(otherUserId) {
                const roomId = getChatRoomId(this.currentUser.id, otherUserId);
                socket.emit('join_room', roomId);
                try {
                    const res = await fetch(`/api/chats/${otherUserId}?chatId=${roomId}`);
                    this.chats[roomId] = await res.json();
                    updateUI();
                } catch (e) { this.chats[roomId] = []; updateUI(); }
            }
            
            async createUser(n,u,p) { return (await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, username:u, password:p})})).json(); }
            async changePassword(p) { const r = await fetch(`/api/users/${this.currentUser.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:p})}); this.currentUser.mustChangePassword=false; localStorage.setItem('sTalk_user', JSON.stringify(this.currentUser)); return r.json(); }
            async adminResetPassword(id,p) { return (await fetch('/api/admin/reset-password', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id, newPassword:p})})).json(); }
            async deleteUser(id) { await fetch(`/api/users/${id}`, {method:'DELETE'}); this.fetchUsers(); }
            addMessageToLocal(msg) { const rid = msg.chatId; if(!this.chats[rid]) this.chats[rid]=[]; this.chats[rid].push(msg); }
        }

        function getChatRoomId(id1, id2) { return [id1, id2].sort().join('_'); }
        const server = new APIClient();
        let activeChatId = null, replyContext = null;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = localStorage.getItem('sTalk_sound') !== 'false';

        function playNotificationSound() {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            if (!soundEnabled) return;
            const t = audioCtx.currentTime, o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(1200, t); o.frequency.exponentialRampToValueAtTime(800, t + 0.1);
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
            o.start(t); o.stop(t + 1.5);
        }

        window.addEventListener('load', async () => {
             // Register SW only if not in preview blob
            if ('serviceWorker' in navigator && window.location.protocol !== 'blob:') {
                 try { navigator.serviceWorker.register('/sw.js'); } catch(e){}
            }
            if (await server.checkAuth()) enterMainApp(server.currentUser);
        });
    </script>

    <!-- VIEWS -->
    <div id="view-login" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-gray-700">
            <img src="logo.svg" class="w-24 h-24 mx-auto mb-6 rounded-[20px] shadow-lg" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='block'">
            <div id="fallback-logo" class="hidden w-24 h-24 mx-auto mb-6 rounded-[20px] bg-purple-600"></div>
            <h1 class="text-2xl font-extrabold text-white mb-2">sTalk Login</h1>
            <input type="text" id="login-user" placeholder="Username" class="w-full p-4 rounded-xl bg-gray-700 text-white mb-3 outline-none font-semibold">
            <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-700 text-white mb-4 outline-none font-semibold">
            <button onclick="appLogin()" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-purple-600 to-blue-500 text-white font-bold shadow-lg active:scale-95 transition-transform">Login</button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="view-main" class="hidden flex-1 flex overflow-hidden relative bg-gray-900 text-white">
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-80 lg:w-96 bg-gray-800 border-r border-gray-700 flex flex-col z-10">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openSettingsModal()">
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-purple-900 flex items-center justify-center text-purple-300 font-bold overflow-hidden border border-gray-700"></div>
                    <h2 id="my-username" class="font-bold text-white text-lg">User</h2>
                </div>
                <div class="flex gap-3">
                    <button id="admin-btn" onclick="toggleAdminPanel()" class="hidden w-8 h-8 rounded-full bg-red-900 flex items-center justify-center"><i class="fas fa-shield-alt"></i></button>
                    <button onclick="openSettingsModal()" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="p-3">
                <input type="text" placeholder="Search" class="w-full p-2 bg-gray-700 rounded-lg text-white outline-none">
            </div>
            <div id="user-list" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- CHAT INTERFACE -->
        <div id="chat-interface" class="flex-1 bg-gray-900 flex flex-col absolute inset-0 md:static transform translate-x-full md:translate-x-0 transition-transform duration-300 z-20">
            <!-- HEADER -->
            <div id="chat-header" class="bg-gray-800 p-3 border-b border-gray-700 flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="md:hidden text-gray-300 p-2"><i class="fas fa-arrow-left text-xl"></i></button>
                    <div class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden flex items-center justify-center">
                        <img id="chat-header-avatar" class="w-full h-full object-cover hidden"><span id="chat-header-initials" class="hidden"></span>
                    </div>
                    <div>
                        <h3 id="chat-header-name" class="font-bold text-white">Name</h3>
                        <p id="chat-header-status" class="text-xs text-green-500">Online</p>
                    </div>
                </div>
                <button onclick="deleteCurrentChat()" class="text-red-400"><i class="fas fa-trash"></i></button>
            </div>

            <!-- SCROLLABLE MESSAGES -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-cover bg-center"></div>

            <!-- INPUT AREA -->
            <div id="chat-input-area" class="bg-gray-800 p-3 flex items-end gap-2 border-t border-gray-700">
                <button onclick="document.getElementById('file-input').click()" class="p-3 text-gray-400 hover:text-purple-500"><i class="fas fa-paperclip"></i></button>
                <input type="file" id="file-input" class="hidden" multiple onchange="handleFiles(this.files)">
                <input type="text" id="msg-input" placeholder="Message" class="flex-1 bg-gray-700 rounded-2xl px-4 py-2 outline-none text-white" onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" class="p-3 bg-purple-600 text-white rounded-full"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- SETTINGS & CROPPER -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl overflow-hidden flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between">
                <h3 class="text-lg font-bold text-white">Settings</h3>
                <button onclick="closeSettingsModal()"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex flex-col items-center mb-6">
                    <div class="relative cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                        <div id="settings-avatar" class="w-24 h-24 rounded-full bg-purple-900 border-4 border-gray-700 overflow-hidden flex items-center justify-center"></div>
                    </div>
                    <button onclick="document.getElementById('avatar-upload').click()" class="text-purple-400 text-sm font-bold mt-2">Change Profile Photo</button>
                </div>
                <div class="mb-6">
                     <div class="flex justify-between items-center">
                        <span class="font-bold text-white">Push Notifications</span>
                        <button onclick="server.registerPush()" class="bg-purple-600 px-3 py-1 rounded text-sm font-bold">Enable</button>
                    </div>
                </div>
                <button onclick="logout()" class="w-full p-3 rounded-xl bg-red-900 text-red-200 font-bold">Log Out</button>
            </div>
        </div>
    </div>

    <!-- CROPPER -->
    <div id="cropper-modal" class="hidden fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-lg rounded-2xl overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex justify-between"><h3 class="text-white font-bold">Adjust Photo</h3><button onclick="closeCropper()" class="text-white"><i class="fas fa-times"></i></button></div>
            <div class="p-4">
                <div class="relative w-full h-64 bg-black rounded-lg overflow-hidden" id="crop-container" 
                     ontouchstart="startDrag(event)" ontouchmove="drag(event)" ontouchend="endDrag()" 
                     onmousedown="startDrag(event)" onmousemove="drag(event)" onmouseup="endDrag()">
                    <canvas id="crop-canvas" class="absolute top-0 left-0"></canvas>
                    <div class="absolute inset-0 pointer-events-none border-[50px] border-black/60 rounded-full"></div>
                </div>
                <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1" class="w-full mt-4" oninput="updateZoom(this.value)">
                <button onclick="saveCrop()" class="w-full mt-4 bg-purple-600 text-white py-3 rounded-lg font-bold">Save</button>
            </div>
        </div>
    </div>
    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="initCropper(this)">

    <script>
        // APP LOGIC
        function appLogin() {
            const u = document.getElementById('login-user').value, p = document.getElementById('login-pass').value;
            server.login(u, p).then(user => enterMainApp(user)).catch(e => alert(e));
        }
        function enterMainApp(user) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('view-main').classList.add('flex');
            updateMyProfileUI();
            if(user.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
        }
        function logout() { localStorage.removeItem('sTalk_user'); window.location.reload(); }
        
        // CROPPER
        let cropCanvas, cropCtx, cropImg, cropState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false };
        function initCropper(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                cropImg = new Image(); cropImg.src = e.target.result;
                cropImg.onload = () => {
                    document.getElementById('cropper-modal').classList.remove('hidden');
                    document.getElementById('settings-modal').classList.add('hidden');
                    cropCanvas = document.getElementById('crop-canvas'); 
                    cropCtx = cropCanvas.getContext('2d');
                    const c = document.getElementById('crop-container');
                    cropCanvas.width = c.offsetWidth; cropCanvas.height = c.offsetHeight;
                    cropState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false };
                    drawCropper();
                }
            };
            reader.readAsDataURL(input.files[0]);
            input.value = "";
        }
        function closeCropper() { document.getElementById('cropper-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('hidden'); }
        function drawCropper() {
            cropCtx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
            const w = cropImg.width*cropState.scale, h = cropImg.height*cropState.scale;
            const x = (cropCanvas.width-w)/2 + cropState.offsetX, y = (cropCanvas.height-h)/2 + cropState.offsetY;
            cropCtx.drawImage(cropImg, x, y, w, h);
        }
        function updateZoom(v) { cropState.scale = parseFloat(v); drawCropper(); }
        function startDrag(e) { cropState.isDragging=true; const p = e.touches?e.touches[0]:e; cropState.sx = p.clientX-cropState.offsetX; cropState.sy = p.clientY-cropState.offsetY; }
        function drag(e) { if(!cropState.isDragging)return; e.preventDefault(); const p = e.touches?e.touches[0]:e; cropState.offsetX = p.clientX-cropState.sx; cropState.offsetY = p.clientY-cropState.sy; drawCropper(); }
        function endDrag() { cropState.isDragging=false; }
        function saveCrop() {
            const sc = document.createElement('canvas'); sc.width=200; sc.height=200;
            sc.getContext('2d').drawImage(cropCanvas, (cropCanvas.width/2-100), (cropCanvas.height/2-100), 200, 200, 0, 0, 200, 200);
            // Send to server
            server.updateUser({ avatar: sc.toDataURL() });
            closeCropper();
        }

        function updateMyProfileUI() {
            const u = server.currentUser;
            document.getElementById('my-username').innerText = u.name;
            document.getElementById('my-avatar').innerHTML = renderAvatar(u, "w-full h-full");
            document.getElementById('settings-name').innerText = u.name;
            document.getElementById('settings-avatar').innerHTML = renderAvatar(u, "w-full h-full", "text-3xl");
        }

        function renderUserList() {
            const list = document.getElementById('user-list');
            const others = server.users.filter(u => u.id !== server.currentUser.id);
            
            list.innerHTML = others.map(u => {
                // UNREAD COUNT LOGIC
                const unreadCount = (server.currentUser.unread && server.currentUser.unread[u.id]) || 0;
                const badge = unreadCount > 0 ? 
                    `<div class="unread-badge absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center shadow-md">${unreadCount}</div>` : '';
                const nameClass = unreadCount > 0 ? 'font-extrabold text-white italic' : 'font-semibold text-gray-300';
                
                return `
                <div onclick="openChat(${u.id})" class="p-4 flex items-center gap-3 hover:bg-gray-800 cursor-pointer border-b border-gray-700 transition-colors">
                    <div class="relative w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center font-bold border border-gray-600">
                        ${renderAvatar(u, "w-full h-full", "text-lg")}
                        ${u.status === 'online' ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-800"></div>' : ''}
                        ${badge}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between"><h3 class="${nameClass}">${u.name}</h3></div>
                        <p class="text-sm text-gray-500 truncate">${unreadCount > 0 ? 'New messages' : 'Tap to chat'}</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        // UI & Chat
        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function toggleAdminPanel() { document.getElementById('admin-panel').classList.toggle('hidden'); }
        
        function openChat(userId) {
            activeChatId = userId;
            const u = server.users.find(u => u.id === userId);
            document.getElementById('chat-header-name').innerText = u.name;
            const img = document.getElementById('chat-header-avatar'), txt = document.getElementById('chat-header-initials');
            if(u.avatar && u.avatar.length > 10) { img.src=u.avatar; img.classList.remove('hidden'); txt.classList.add('hidden'); }
            else { img.classList.add('hidden'); txt.classList.remove('hidden'); txt.innerText = getInitials(u.name); }
            
            if(window.innerWidth < 768) document.getElementById('chat-interface').classList.remove('translate-x-full');
            
            server.loadMessages(userId);
            server.markRead(userId); // Clear unread on open
        }
        
        function closeChat() {
            activeChatId = null;
            if(window.innerWidth < 768) document.getElementById('chat-interface').classList.add('translate-x-full');
        }
        
        function sendMsg() {
            const i = document.getElementById('msg-input'), v = i.value.trim();
            if(v) { server.sendMessage(activeChatId, v).then(()=>i.value=''); }
        }
        
        function handleFiles(files) {
            Array.from(files).forEach(f => {
                const r = new FileReader();
                r.onload = e => server.sendMessage(activeChatId, "", f.type.startsWith('image')?'image':f.type.startsWith('video')?'video':'file', e.target.result);
                r.readAsDataURL(f);
            });
        }
        
        function renderAvatar(u, c, f="text-base") {
            if(u.avatar && u.avatar.length > 10) return `<img src="${u.avatar}" class="${c} object-cover w-full h-full">`;
            return `<div class="${c} flex items-center justify-center ${f}">${getInitials(u.name)}</div>`;
        }
        function getInitials(n) { return n.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase(); }
    </script>
</body>
</html>